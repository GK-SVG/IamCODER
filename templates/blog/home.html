{% extends 'base.html' %}


{% block homeactive %}active {% endblock homeactive%}
{% block body %}
{% load static %}
<div class="container" style="margin-top:6em;">
    <div class="row" id="all_blogs">
        <div class="col-md-12">
            <h3><b>Latest Tech Blogs</b></h3>
        </div>
        {% for blog in blogs reversed %}
        <div class="col-lg-4 col-md-6 col-sm-6 col-12 mt-3">
            <a href="{% url 'blogpost' blog.post_id %}" style="text-decoration: none;">
                <div class="card" style="width: 21rem; min-height: 22rem;">
                    <img src="{{blog.IMG_url}}" class="card-img-top" style="height:12rem;" alt="Img not found">
                    <div class="card-body" style="color: black;">
                        <h5 class="card-title">{{blog.title|truncatechars:50}}</h5>
                        {{blog.pub_date}} <b>{{blog.user.username}}</b>({{blog.view}} views)
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>

    <div id="loadBtn" class="mt-4 btn btn-info col-md-12 col-sm-12 col-12" onclick="load_blogs()">
        Load More
    </div>
</div>

<script>
    var blogCount = Number("{{blogCount}}")

    function load_blogs() {
        if(!localStorage.getItem("current_post_count")){
            localStorage.setItem("current_post_count","{{ global_blog_count }}")
            var current_post_count = Number("{{ global_blog_count }}")
            console.log("IF block current_post_count--",current_post_count)
        }
        else{
          current_post_count = Number(localStorage.getItem("current_post_count"))
          console.log("else Block current_post_count--",current_post_count)
        }
        let url = `/loadMore/${current_post_count}`
        fetch(url, {
                method: "GET",
            })
            .then((response) => {
                return response.json();
            })
            .then((response) => {
                console.log('responce--', response)
                var temp = Number("{{ global_blog_count }}")
                current_post_count += temp
                console.log('current_post_count--',current_post_count)
                localStorage.removeItem("current_post_count")
                localStorage.setItem("current_post_count",current_post_count)
                if (current_post_count >= blogCount) {
                    var btn = document.getElementById("loadBtn")
                    btn.onclick = ""
                    btn.innerText = "No Posts to load"
                    console.log('current_post_count--',blogCount)
                    localStorage.removeItem("current_post_count")
                    localStorage.setItem("current_post_count",blogCount)
                }
                add_Blogs(response)
            }).catch((err) => {
                console.log('error--', err)
            });

    }
    load_blogs()
    function add_Blogs(data) {
        var html = ""
        data.forEach(blog => {

            html += `<div class="col-lg-4 col-md-6 col-sm-6 col-12 mt-3">
                        <a href="/blogpost/${blog.pk}" style="text-decoration: none;">
                            <div class="card" style="width: 21rem; min-height: 22rem;">
                                <img src="${blog.fields.IMG_url}" class="card-img-top" style="height:12rem;" alt="Img not found">
                                <div class="card-body" style="color: black;">
                                    <h5 class="card-title">${blog.fields.title.slice(0,50)}</h5>
                                    ${getDate(blog.fields.pub_date)} <b>${getUserName(blog.fields.user)}(${blog.fields.view} views)</b>
                        
                                </div>
                            </div>
                        </a>
                    </div>`
        });

        document.querySelector("#all_blogs").insertAdjacentHTML('beforeend', html)
        // all_blogs.append(html)
    }

    function getDate(currentDate) {
        // console.log("currentDate--",currentDate)
        var monthList = ["JAN.", "FEB.", "MAR.", "APR.", "MAY.", "JUN.", "JUL.", "AUG.", "SEP.", "OCT.", "NOV.", "DEC."]
        let date = new Date(currentDate);
        let time = date.toLocaleTimeString([], {
            hour12: true,
            hour: "2-digit",
            minute: "2-digit",
        });
        let completeDate = `${monthList[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()} ,${time} `;
        return completeDate;
    }

    function getUserName(user) {
        return "{{user.username}}"
    }

    
</script>
{% endblock body %}